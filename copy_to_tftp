#$language = "Python"
#$interface = "1.0"

import os

user = "test"
passwd = crt.Dialog.Prompt("PIN and OTP", "Login", "", True)
server = "192.168.1.10"
confg = "confg"

def Main():
	errorMessages = ""

	sessionsFileName = open(r"C:\Users\IEUser\Desktop\hosts.txt", "r")
	if not os.path.exists("C:\Users\IEUser\Desktop\hosts.txt"):
		crt.Dialog.MessageBox(
			"Session list file not found:\n\n" +
			sessionsFileName + "\n\n" +
			"Create a session list file as described in the description of " +
			"this script code and then run the script again.")
		return

	sessionFile = open(r"C:\Users\IEUser\Desktop\hosts.txt", "r")
	sessionsArray = []

	for line in sessionFile:
		session = line.strip()
		if session:
			sessionsArray.append(session)

	sessionFile.close()

	for session in sessionsArray:

		try:
			crt.Session.Connect("/SSH2 /L %s /PASSWORD %s /C 3DES /M SHA1 %s" % (user, passwd, session))
		except ScriptError:
			error = crt.GetLastErrorMessage()

		if crt.Session.Connected:
			crt.Screen.Synchronous = True
			while True:				
				if not crt.Screen.WaitForCursor(1):
					break
			
			row = crt.Screen.CurrentRow
			prompt = crt.Screen.Get(row, 0, row, crt.Screen.CurrentColumn - 1)
			prompt = prompt.strip()
			
			crt.Screen.Send("conf t\n")
			crt.Screen.WaitForString("(config)#")

			crt.Screen.Send("file prompt quiet\n")
			crt.Screen.WaitForString("(config)#")
            
			crt.Screen.Send("exit\n")
			crt.Screen.WaitForString("#")

			mycommand = "show run | inc ^hostname\r"
			crt.Screen.Send(mycommand)
			crt.Screen.WaitForStrings([mycommand + "\r", mycommand + "\n"])
			strHostnameData = crt.Screen.ReadString(["\r", "\n"])
			strHostname = strHostnameData.split()[1]         
			crt.Screen.WaitForString("#")
			
			cmd = "copy run tftp://%s/%s-%s\n" % (server, strHostname, confg)
			crt.Screen.Send(cmd)
			crt.Screen.WaitForString("#")

			crt.Session.Disconnect()
			# Wait for the connection to close
			while crt.Session.Connected == True:
				crt.Sleep(100)

			crt.Sleep(1000)
		else:
			errorMessages = errorMessages + "\n" + "*** Error connecting to " + session + ": " + error

	if errorMessages == "":
		crt.Dialog.MessageBox("Tasks completed.  No Errors were detected.")
	else:
		crt.Dialog.MessageBox("Tasks completed.  The following errors occurred:\n" + errorMessages)

#	crt.Quit()

Main()
